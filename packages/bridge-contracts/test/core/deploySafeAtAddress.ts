import { ethers } from "hardhat";
import { keccak256 } from "ethers/lib/utils";

function padZeroes(key: any, length = 64) {
    const no0x = key.replace("0x", "");
    return "0".repeat(length - no0x.length) + no0x;
}

function numberToKey(slot: any) {
    let hexSlot = slot.toString(16);
    if (hexSlot.length % 2 === 1) hexSlot = "0" + hexSlot;
    return padZeroes(hexSlot);
}

export async function deploySafeAtAddress(address: string, threshold: number, owners: string[]) {
    await ethers.provider.send("hardhat_setCode", [
        address,
        "0x6080604052600436106100435760003560e01c80632f54bf6e14610087578063468721a7146100bc578063a0e67e2b146100dc578063e75235b8146100fe57600080fd5b3661008257604080513281523460208201527f88a5966d370b9919b20f3e2c13ff65706f196a4e32cc2c12bf57088f88525874910160405180910390a1005b600080fd5b34801561009357600080fd5b506100a76100a236600461036c565b61011c565b60405190151581526020015b60405180910390f35b3480156100c857600080fd5b506100a76100d73660046103b3565b610188565b3480156100e857600080fd5b506100f1610242565b6040516100b3919061048f565b34801561010a57600080fd5b506000546040519081526020016100b3565b6000610182600180548060200260200160405190810160405280929190818152602001828054801561017757602002820191906000526020600020905b81546001600160a01b03168152600190910190602001808311610159575b5050505050836102a4565b92915050565b600061019985858585600019610309565b905080156101d15760405133907f6895c13664aa4f67288b25d7a21d7aaa34916e355fb9b6fae0a139a9085becb890600090a26101fd565b60405133907facd2c8702804128fdb0db2bb49f6d127dd0181c13fd45dbfe16de0930e2bd37590600090a25b7f972dc63a6967991b9c6b63c2b89ee2050cf133a5cf63c1ad4f39b995d977e2228585858560405161023294939291906104f2565b60405180910390a1949350505050565b6060600180548060200260200160405190810160405280929190818152602001828054801561029a57602002820191906000526020600020905b81546001600160a01b0316815260019091019060200180831161027c575b5050505050905090565b6000805b83518110156102ff57826001600160a01b03168482815181106102cd576102cd61057c565b60200260200101516001600160a01b0316036102ed576001915050610182565b806102f781610592565b9150506102a8565b5060009392505050565b6000600183600181111561031f5761031f6104dc565b03610337576000808551602087018986f49050610347565b600080855160208701888a87f190505b95945050505050565b80356001600160a01b038116811461036757600080fd5b919050565b60006020828403121561037e57600080fd5b61038782610350565b9392505050565b634e487b7160e01b600052604160045260246000fd5b80356002811061036757600080fd5b600080600080608085870312156103c957600080fd5b6103d285610350565b935060208501359250604085013567ffffffffffffffff808211156103f657600080fd5b818701915087601f83011261040a57600080fd5b81358181111561041c5761041c61038e565b604051601f8201601f19908116603f011681019083821181831017156104445761044461038e565b816040528281528a602084870101111561045d57600080fd5b826020860160208301376000602084830101528096505050505050610484606086016103a4565b905092959194509250565b6020808252825182820181905260009190848201906040850190845b818110156104d05783516001600160a01b0316835292840192918401916001016104ab565b50909695505050505050565b634e487b7160e01b600052602160045260246000fd5b60018060a01b038516815260006020858184015260806040840152845180608085015260005b818110156105345786810183015185820160a001528201610518565b50600060a0828601015260a0601f19601f830116850101925050506002831061056d57634e487b7160e01b600052602160045260246000fd5b82606083015295945050505050565b634e487b7160e01b600052603260045260246000fd5b6000600182016105b257634e487b7160e01b600052601160045260246000fd5b506001019056fea264697066735822122027389dcfa8ddd0d8af2329d9c72469031b0fdcd5305b285d02d17b592e45784364736f6c63430008120033",
    ]);
    await ethers.provider.send("hardhat_setStorageAt", [address, "0x0", `0x${padZeroes(threshold.toString(16))}`]);

    const mainSlotKey = numberToKey(1);

    await ethers.provider.send("hardhat_setStorageAt", [address, `0x1`, `0x${padZeroes(owners.length.toString(16))}`]);
    const arrayBaseKey = ethers.BigNumber.from(keccak256(Buffer.from(mainSlotKey, "hex")));
    for (let i = 0; i < owners.length; i++) {
        await ethers.provider.send("hardhat_setStorageAt", [address, arrayBaseKey.add(i).toHexString(), "0x" + padZeroes(owners[i])]);
    }
}
